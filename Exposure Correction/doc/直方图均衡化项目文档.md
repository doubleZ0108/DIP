# 直方图均衡化项目文档

[TOC]

------

## 直方图均衡化基础知识

### 直方图

#### 定义

统计图像中每个像素的个数，用横坐标表示各个像素值，纵坐标表示对应像素值的个数，绘制得到的图像就是直方图。从直方图中我们可以清楚的看到图像中各个像素的分布。

#### 性质

- 直方图的动态范围越宽，图像的对比度越大

  > 例. 第一张图像的直方图聚集在中间的位置，而第二张图像的直方图分布较宽；而第一张图像给人的视觉效果是灰蒙蒙的，而第二张图像的对比度更大，视觉效果更好
  >
  > <img src="../../../../Library/Application Support/typora-user-images/image-20191109211824997.png" alt="image-20191109211824997" style="zoom:50%;" />
  >
  > <img src="../../../../Library/Application Support/typora-user-images/image-20191109211834897.png" alt="image-20191109211834897" style="zoom:50%;" />
  >
  > <img src="../../../../Library/Application Support/typora-user-images/image-20191109211800596.png" alt="image-20191109211800596" style="zoom:50%;" />
  >
  > <img src="../../../../Library/Application Support/typora-user-images/image-20191109211646864.png" alt="image-20191109211646864" style="zoom:50%;" />

- 给定图像，直方图是唯一确定的

- 但是，给定直方图，图像无法确定

  > 🔎想想为什么
  >
  > 例如，这两张图像的直方图都为第三张图片所示
  >
  > <img src="../../../../Library/Application Support/typora-user-images/image-20191109211800596.png" alt="image-20191109211800596" style="zoom:50%;" />
  >
  > <img src="../../../../Library/Application Support/typora-user-images/image-20191109211710359.png" alt="image-20191109211710359" style="zoom:50%;" />
  >
  > <img src="../../../../Library/Application Support/typora-user-images/image-20191109211646864.png" alt="image-20191109211646864" style="zoom:50%;" />

#### 计算方法

统计图形中各个像素的个数

例子.

<img src="../../../../Library/Application Support/typora-user-images/image-20191109211458421.png" alt="image-20191109211458421" style="zoom:50%;" />

### 直方图均衡化

寻找一个方法（其实本质是使用一个函数）将图像中不同像素个数尽量平均化，以达到更好的视觉效果。

**公式：**
$$
s = (L-1)\sum_{j=0}^{k}\frac{n_j}{M*N}
$$

- $L$: 总灰度级数
- $M*N$: 图像尺寸
- $n_j$: 直方图中第j项的值

------

## 直方图均衡化代码实现

### 显示图像直方图

#### 库函数 --- plt.hist

使用pyplot的hist方法可以直接生成直方图

```python
img_arr = img.flatten()	
n, bins, patches = plt.hist(img_arr, bins=256, facecolor='blue', alpha=0.75)
```

- **参数：**
  - img_arr: 需要计算直方图的一维数组
  - bins: 直方图的柱数，可选项，默认为10
  - normed: 是否将得到的直方图向量归一化。默认为0
  - facecolor: 直方图颜色
  - alpha: 透明度
- **返回值：**
  - n: 直方图向量，是否归一化由参数设定
  - bins: 返回各个bin的区间范围
  - patches: 返回每个bin里面包含的数据，是一个list

**效果**

<img src="../../../../Library/Application Support/typora-user-images/image-20191109221545222.png" alt="image-20191109221545222" style="zoom:50%;" />

#### 库函数 --- cv2.calcHist

```python
hist = cv2.calcHist([res],[0],None,[256],[0,255])
plt.plot(hist,'r')
plt.show()
```

<img src="https://img-blog.csdn.net/20180902112055224?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM3Mzg1NzI2/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70" alt="img" style="zoom:50%;" />

#### 直接计算直方图

统计各个像素的个数，绘制以像素为横轴，该像素数量为纵轴的图像

```python
def generate_histogram(img):
    '''
    @description: 用定义法生成图像的直方图

    @params img: 图像（二维矩阵）

    @return : null
    '''
    height, width = img.shape[:2]
    histogram = np.zeros([256])
    for i in range(height):
        for j in range(width):
            histogram[img[i][j]] += 1

    x = np.arange(256)
    plt.figure()
    plt.plot(x, histogram, 'r', linewidth=2, c='black')
    plt.show()
```

**效果**

<img src="../../../../Library/Application Support/typora-user-images/image-20191109221529504.png" alt="image-20191109221529504" style="zoom:50%;" />

------

### 直方图均衡化

#### 库函数 --- cv2.equalizeHist

```python
img = cv2.imread('../../Resources/Histogram/origin.png', 0)
new_img = cv2.equalizeHist(img)
```

#### 自定义算法

1. 以灰度图的方式加载图片
2. 求出原图的灰度直方图，计算每个灰度的像素个数在整个图像中所占的百分比
3. 计算图像各灰度级的累积概率密度分布
4. 求出新图像的灰度值。

```python
img = cv2.imread('../../Resources/Histogram/origin.png')
new_img = histeq(img)
```

```python
def histeq(img):
    '''
    @description: 对图像进行直方图均衡化

    @params : 图像

    @return : null
    '''
    histogram = get_histogram(img)

    pr = {}  # 建立概率分布映射表

    for i in histogram.keys():
        pr[i] = histogram[i] / (img.shape[0] * img.shape[1])

    tmp = 0
    for m in pr.keys():
        tmp += pr[m]
        pr[m] = max(histogram) * tmp

    new_img = np.zeros(shape=(img.shape[0], img.shape[1]), dtype=np.uint8)

    for k in range(img.shape[0]):
        for l in range(img.shape[1]):
            new_img[k][l] = pr[img[k][l][0]]

    return new_img
```

```python
def get_histogram(img):
    '''
    @description: 计算图像的直方图信息

    @params : 图像

    @return : null
    '''
    # 建立原始图像各灰度级的灰度值与像素个数对应表
    histogram = {}
    for i in range(img.shape[0]):
        for j in range(img.shape[1]):
            k = img[i][j][0]
            if k in histogram:
                histogram[k] += 1
            else:
                histogram[k] = 1

    sorted_histogram = {}               # 建立排好序的映射表
    sorted_list = sorted(histogram)     # 根据灰度值进行从低至高的排序

    for j in range(len(sorted_list)):
        sorted_histogram[sorted_list[j]] = histogram[sorted_list[j]]

    return sorted_histogram
```

------

## 直方图均衡化实战

### 灰度图

下方的两个例子为我们展示了直方图均衡化的魔力，原图和原图的直方图如下，之后是直方图均衡化后的图像和对应的直方图

#### 例一

**原图**

<img src="../../../../Library/Application Support/typora-user-images/image-20191110001431995.png" alt="image-20191110001431995" style="zoom:25%;" />

**原图的直方图**

<img src="../../../../Library/Application Support/typora-user-images/image-20191110001502685.png" alt="image-20191110001502685" style="zoom: 25%;" />

**直方图均衡化**

<img src="../../../../Library/Application Support/typora-user-images/image-20191110001536378.png" alt="image-20191110001536378" style="zoom:25%;" />

**直方图均衡化的直方图**

<img src="../../../../Library/Application Support/typora-user-images/image-20191110001556437.png" alt="image-20191110001556437" style="zoom:25%;" />

#### 例二

原图中我们基本看不到任何信息，但是简单的直方图均衡化之后居然是一张信息很多的图像（神奇吧）

**原图**

<img src="../../../../Library/Application Support/typora-user-images/image-20191110001643522.png" alt="image-20191110001643522" style="zoom:25%;" />

**原图的直方图**

<img src="../../../../Library/Application Support/typora-user-images/image-20191110001706306.png" alt="image-20191110001706306" style="zoom:25%;" />![image-20191110001722075](../../../../Library/Application Support/typora-user-images/image-20191110001722075.png)

**直方图均衡化**

<img src="../../../../Library/Application Support/typora-user-images/image-20191110001722075.png" alt="image-20191110001722075" style="zoom:25%;" />

**直方图均衡化的直方图**

<img src="../../../../Library/Application Support/typora-user-images/image-20191110001747444.png" alt="image-20191110001747444" style="zoom:25%;" />

原图的直方图大致都集中在一个窄的范围内，因此图像的对比度较低，显得灰蒙蒙的，或者几乎难以观察；直方图均衡化将像素均匀化，对比度增强，提高图像的视觉效果

------

### RGB图片